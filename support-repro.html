<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>swisstopo JSAPI scree repro</title>
    <link rel="stylesheet" href="https://js.arcgis.com/5.0/esri/themes/light/main.css" />
    <style>
      html,
      body,
      #viewDiv {
        margin: 0;
        width: 100%;
        height: 100%;
      }

      .panel {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 10px;
        font: 12px/1.3 "Segoe UI", sans-serif;
      }

      .panel label {
        font-weight: 600;
        margin-right: 6px;
      }

      .panel select {
        font: inherit;
      }

      .status {
        margin-top: 8px;
        font-family: ui-monospace, Menlo, Consolas, monospace;
      }
    </style>
  </head>
  <body>
    <div id="viewDiv"></div>
    <div class="panel">
      <label for="mode">Mode</label>
      <select id="mode">
        <option value="baseline" selected>v6 baseline</option>
        <option value="split4">v6 + scree split-4</option>
        <option value="oom">v6 + scree OOM</option>
      </select>
      <div class="status" id="status">loading...</div>
    </div>

    <script type="module">
      const JSAPI = "https://js.arcgis.com/5.0";
      const V6_STYLE_PATH = "./styles/v6.json";
      const DEFAULT_CENTER = [8.595, 46.636];
      const DEFAULT_ZOOM = 13.4;

      const SCREE_LAYER_TEMPLATES = [
        {
          id: "scree_z17",
          type: "fill",
          source: "relief_v1.0.0",
          "source-layer": "scree",
          minzoom: 17,
          layout: { visibility: "visible" },
          paint: {
            "fill-opacity": ["interpolate", ["linear"], ["zoom"], 9, 0, 11, 0.2, 14, 0.25],
            "fill-pattern": [
              "match",
              ["get", "weight"],
              15,
              "scree_very_large_1",
              10,
              "scree_very_large_2",
              5,
              "scree_very_large_3",
              1,
              "scree_very_large_4",
              "",
            ],
          },
        },
        {
          id: "scree_z15",
          type: "fill",
          source: "relief_v1.0.0",
          "source-layer": "scree",
          minzoom: 15,
          maxzoom: 17,
          layout: { visibility: "visible" },
          paint: {
            "fill-opacity": ["interpolate", ["linear"], ["zoom"], 9, 0, 11, 0.2, 14, 0.25],
            "fill-pattern": [
              "match",
              ["get", "weight"],
              15,
              "scree_large_1",
              10,
              "scree_large_2",
              5,
              "scree_large_3",
              1,
              "scree_large_4",
              "",
            ],
          },
        },
        {
          id: "scree_z13",
          type: "fill",
          source: "relief_v1.0.0",
          "source-layer": "scree",
          minzoom: 13,
          maxzoom: 15,
          layout: { visibility: "visible" },
          paint: {
            "fill-opacity": ["interpolate", ["linear"], ["zoom"], 11, 0, 12, 0.2, 14, 0.25],
            "fill-pattern": [
              "match",
              ["get", "weight"],
              15,
              "scree_medium_1",
              10,
              "scree_medium_2",
              5,
              "scree_medium_3",
              1,
              "scree_medium_4",
              "",
            ],
          },
        },
        {
          id: "scree_z11",
          type: "fill",
          source: "relief_v1.0.0",
          "source-layer": "scree",
          minzoom: 11,
          maxzoom: 13,
          layout: { visibility: "visible" },
          paint: {
            "fill-opacity": ["interpolate", ["linear"], ["zoom"], 11, 0, 12, 0.2, 14, 0.25],
            "fill-pattern": [
              "match",
              ["get", "weight"],
              15,
              "scree_small_1",
              10,
              "scree_small_2",
              5,
              "scree_small_3",
              1,
              "scree_small_4",
              "",
            ],
          },
        },
      ];

      const modeSelect = document.getElementById("mode");
      const statusEl = document.getElementById("status");

      function clone(value) {
        if (typeof structuredClone === "function") {
          return structuredClone(value);
        }
        return JSON.parse(JSON.stringify(value));
      }

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function andFilter(a, b) {
        if (!a) return b;
        return ["all", a, b];
      }

      function parseWeightPatternMap(expr) {
        if (!Array.isArray(expr) || expr[0] !== "match") {
          return [];
        }

        const out = [];
        for (let i = 2; i + 1 < expr.length; i += 2) {
          const weight = expr[i];
          const pattern = expr[i + 1];
          if (typeof weight === "number" && typeof pattern === "string" && pattern) {
            out.push({ weight, pattern });
          }
        }

        return out.sort((a, b) => b.weight - a.weight);
      }

      function isScreeLayer(layer) {
        return (
          layer?.type === "fill" &&
          layer?.source === "relief_v1.0.0" &&
          layer?.["source-layer"] === "scree" &&
          String(layer?.id || "").startsWith("scree_z")
        );
      }

      function removeScreeLayers(layers) {
        return layers.filter((layer) => !isScreeLayer(layer));
      }

      function buildSplitLayers() {
        const out = [];
        for (const template of SCREE_LAYER_TEMPLATES) {
          const pairs = parseWeightPatternMap(template?.paint?.["fill-pattern"]);
          for (const { weight, pattern } of pairs) {
            const next = clone(template);
            next.id = `${template.id}_split_w${weight}`;
            next.filter = andFilter(template.filter, ["==", "weight", weight]);
            next.paint["fill-pattern"] = pattern;
            out.push(next);
          }
        }
        return out;
      }

      function buildOomLayers() {
        return SCREE_LAYER_TEMPLATES.map((layer) => clone(layer));
      }

      function findInsertIndex(layers) {
        const idx = layers.findIndex((layer) => layer.id === "contour_line");
        return idx >= 0 ? idx : layers.length;
      }

      function buildStyleForMode(baseStyle, mode) {
        const style = clone(baseStyle);
        let injectedLayers = [];

        if (mode === "baseline") {
          style.name = `v6-${mode}`;
          return { style, injectedIds: [] };
        }

        const stripped = removeScreeLayers(style.layers || []);
        const insertAt = findInsertIndex(stripped);

        if (mode === "split4") {
          injectedLayers = buildSplitLayers();
        } else if (mode === "oom") {
          injectedLayers = buildOomLayers();
        }

        stripped.splice(insertAt, 0, ...injectedLayers);
        style.layers = stripped;
        style.name = `v6-${mode}`;
        return { style, injectedIds: injectedLayers.map((layer) => layer.id) };
      }

      try {
        const [
          { default: esriConfig },
          { default: ArcGISMap },
          { default: MapView },
          { default: VectorTileLayer },
        ] = await Promise.all([
          import(`${JSAPI}/@arcgis/core/config.js`),
          import(`${JSAPI}/@arcgis/core/Map.js`),
          import(`${JSAPI}/@arcgis/core/views/MapView.js`),
          import(`${JSAPI}/@arcgis/core/layers/VectorTileLayer.js`),
        ]);

        esriConfig.assetsPath = `${JSAPI}/@arcgis/core/assets`;

        const response = await fetch(V6_STYLE_PATH, { cache: "no-store" });
        if (!response.ok) {
          throw new Error(`Cannot load ${V6_STYLE_PATH} (${response.status})`);
        }
        const baseStyle = await response.json();

        const map = new ArcGISMap({ basemap: null });
        new MapView({
          container: "viewDiv",
          map,
          center: { longitude: DEFAULT_CENTER[0], latitude: DEFAULT_CENTER[1] },
          zoom: DEFAULT_ZOOM,
        });

        let activeLayer = null;

        async function loadMode(mode) {
          setStatus(`mode=${mode} loading`);
          const { style, injectedIds } = buildStyleForMode(baseStyle, mode);
          const layer = new VectorTileLayer({ style });

          if (activeLayer) {
            map.remove(activeLayer);
            activeLayer.destroy();
            activeLayer = null;
          }

          map.add(layer);
          activeLayer = layer;
          await layer.load();
          const ids = injectedIds.length ? injectedIds.join(",") : "none";
          setStatus(`mode=${mode} loaded screeLayers=${injectedIds.length} ids=${ids}`);
        }

        modeSelect.addEventListener("change", () => {
          loadMode(modeSelect.value).catch((error) => {
            setStatus(`error: ${error?.message || String(error)}`);
            console.error(error);
          });
        });

        await loadMode(modeSelect.value);
      } catch (error) {
        setStatus(`error: ${error?.message || String(error)}`);
        console.error(error);
      }
    </script>
  </body>
</html>
